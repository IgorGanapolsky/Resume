name: Secrets Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  gitleaks:
    name: Gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  custom-scan:
    name: Custom Secret Patterns
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch PR base
        if: github.event_name == 'pull_request'
        run: |
          git fetch --no-tags origin ${{ github.event.pull_request.base.ref }}

      - name: Scan for hardcoded secrets and JS blobs
        run: |
          FAIL=0
          DIFF=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD)

          check() {
            local label="$1" pattern="$2"
            local hits
            hits=$(grep -rE "$pattern" $DIFF 2>/dev/null || true)
            if [ -n "$hits" ]; then
              echo "❌ [$label] found:"
              echo "$hits" | head -5
              FAIL=1
            fi
          }

          FILES=$(find . -type f \( -name "*.md" -o -name "*.txt" -o -name "*.py" -o -name "*.json" -o -name "*.jsonl" \) \
            ! -path "./.git/*" ! -path "./rag/lancedb/*")

          for f in $FILES; do
            grep -El 'AIza[A-Za-z0-9_-]{35}' "$f" && { echo "❌ Google API key in $f"; FAIL=1; } || true
            grep -El 'ghp_[A-Za-z0-9]{36}' "$f" && { echo "❌ GitHub PAT in $f"; FAIL=1; } || true
            grep -El 'sk-ant-[A-Za-z0-9_-]{40}' "$f" && { echo "❌ Anthropic key in $f"; FAIL=1; } || true
            grep -El '[0-9]{3}-[0-9]{2}-[0-9]{4}' "$f" && { echo "❌ SSN pattern in $f"; FAIL=1; } || true
            grep -El 'window\.ENV\s*=\s*\{' "$f" && { echo "❌ Raw window.ENV blob in $f"; FAIL=1; } || true
            grep -El 'window\.__[a-zA-Z]+\s*=\s*\{' "$f" && { echo "❌ Raw window.__appData blob in $f"; FAIL=1; } || true
          done

          [ $FAIL -eq 1 ] && exit 1
          echo "✅ No secrets detected"
