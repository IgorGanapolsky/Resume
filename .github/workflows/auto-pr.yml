name: Auto Create PR

on:
  push:
    branches:
      - "main"
      - "claude/**"
      - "feat/**"
      - "fix/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    if: startsWith(github.ref_name, 'claude/') || startsWith(github.ref_name, 'feat/') || startsWith(github.ref_name, 'fix/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING=$(gh pr list --head "${{ github.ref_name }}" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -z "$EXISTING" ]; then
            COMMIT_MSG=$(git log -1 --format=%s)
            CHANGES=$(git log origin/main..HEAD --oneline | head -10)
            cat > /tmp/pr_body.md <<EOF
            ## Summary
            Auto-generated PR from \`${{ github.ref_name }}\`

            ## Changes
            $CHANGES

            ## Checklist
            - [ ] Tests pass
            - [ ] No secrets committed
            - [ ] Job files scrubbed
            - [ ] RAG index rebuilt if tracker changed
            EOF
            gh pr create \
              --title "$COMMIT_MSG" \
              --body-file /tmp/pr_body.md \
              --base main
            echo "âœ… PR created"
          else
            echo "PR #$EXISTING already exists"
          fi

  noop-on-main:
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    steps:
      - run: echo "Auto PR workflow is not applicable on main."
